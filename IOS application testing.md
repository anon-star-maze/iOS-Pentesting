# IOS application security testing

## Method 1 - with Jailbroken Device(JBD)

##### Jailbreak your testing device:
* Use checkra1n or any other popular jailbreaking framework [https://checkra.in/]
* Other- Unc0ver Jailbreak [https://unc0ver.dev/]
* Pangu [https://pangu8.com/]
* Electra Jailbreak [https://coolstar.org/electra/]

##### Next Steps:
* Install Xcode
* Install SSH using Cydia (alternative app store) or use Selio (another alt app store)
* Install objection (Frida library) [https://github.com/sensepost/objection]
> pip3 install objection
* Install Frida server for your version of ARM device in device and Frida client on your testing laptop
> pip3 install frida-tools
> ssh root@<mobileip> 		__//Verify ssh connection, password is "alpine" by default__
* Use Xcode(IDE for iOS) to develop/simulate an iOS application
* You may also install Mobexler [https://mobexler.com/] which is a customized virtual machine, designed to help in penetration testing of Android & iOS applications. 

#### Frida commands:
> frida -U -n "appname" 		__//Connect device with Xcode (over USB)__
> frida-ps -Uai 		__//type this is terminal of your testing laptop to identify bundle identifier and list all applications in the device__
> signvc = ObjC.classes.SigninViewController 		__//Retrieve handle of signinviewcontroller classes__
> signvc.$ownMethods 		__//retrieve methods inside the above class__
> frida -U <appname> 		__//Start Frida Gadget__
> frida -U -l somescript.js <appname> 		__//Inject JavaScript__
> frida-trace -U APPNAME -i "METHODNAME"$ 		__//Method tracing__


#### Objection commands:
> objection --gadget "com.app.name" explore 		__//Hook into the application__
* Create a provisioning (developer) profile to sign the applications while pentesting

#### Xcode tasks:
* Create a new dummy application to create your provisioning certificate
* On your device, go to settings and trust your own created certificate
* Find your dummy application using finder and show package contents, there you will find the embedded.mobileprovision file, copy this file to the folder where your target application is placed
* Sign the application using mobileprovision file because without signing the application would not install in device or simulator
* Install applesign [https://www.npmjs.com/package/applesign]

#### Applesign command:
> npm i applesign
> applesign -L 		__//Lists all signing identities(long string of characters) available__
> applesign -i <your signing identity> <apptobesigned.ipa> -m embedded.mobileprovision 		__//new signed app will be created__


## Method 2 - with Non-Jailbroken Device(NJBD)

* Install applesign [https://www.npmjs.com/package/applesign]
* Install Xcode and other dependencies [https://github.com/sensepost/objection/wiki/Patching-iOS-Applications]
* Install insert_dylib [https://github.com/Tyilo/insert_dylib]
* Install ios-deploy [https://www.npmjs.com/package/ios-deploy]

##### Patch the application with Frida server using objection:
> applesign -L 		__//Lists all signing identities(long string of characters) available__
> objection patchipa --source targetapp.ipa --codesign-signature <your signing identity>  -P <path to provisioning profile>		__//new patched file will be created__
> cp <patchedapp.ipa> frida.zip
> unzip 		__//view folders of ipa file__
* It will contain a directory called 'Payload' containing a directory with our app name. Inside which there will be folder named 'frameworks' containing a Fridagadgets.dylib file. 		__//This confirms our patching of application with Frida__
* On your non-jailbroken device, go to settings and trust your own created certificate
* Run ios-deploy in Payload folder:
>ios-deploy --bundle <bundlename.app> --debug -W		__//installs and launches the application in debug mode__
frida -U -n "appname"

#### Proxy setup and file transfer
* Use burpsuite to capture requests/responses from/to the application
* Configure manual proxy on your device to proxy of burpsuite, install Burp certificate, trust the certificate on your device
* Use SFTP to transfer files (eg. command - Get)


> #### Decrypting iOS apps downloaded from Apple App Store
Use out of the following- 
> Clutch [https://github.com/KJCracks/Clutch]
> bfinject[https://github.com/BishopFox/bfinject]
> Frida Ios Dump [https://github.com/AloneMonkey/frida-ios-dump]
> Extract the git and run nano dump.py 		__//nano/vim and provide the ssh credentials/IP of iPhone so it can decrypt the__running application 
> python dump.py "bundle.identifier" 		__//It will create a decypted IPA file__
> Optionally we may use a paid software called "Hopper"


## Top 10 iOS test cases:

### 1. Check stored data on client side/local storage in the following-
* Plist files (xml file)
* NSUserDefaults (xml file)
* SQLite Databases
* Core Data
You may find sensitive data like usernames, passwords, IP addresses, tokens, keys, database etc. 

##### _JBD_
* Connect to application using ssh through terminal
* Launch the application
* Go to /var/mobile/Containers/Data/Application 		__//to see various UUIDs your phone has to assign when you install a new app__
> find -type d -name  <bundleidentifier> 		__//find location of our installed application__
* List the directories and browse for juicy files like plist
* Copy sqlite database files and connect it using SQLite browser tool
* Run basic SQL commands
> .tables; 		__//shows tables in database__
> select * from <tablename> 		__//select everything from table__

##### _NJBD_
> ios-deploy --bundle <bundlename.app> --debug -W		__//installs and launches the application in debug mode__
> objection explore 		__//opens an objection shell__
* Launch the application and check its connection with its respective application server
> env 		__//In objection shell, Shows all paths of the application like Bundle path, documents directory, cache directory and library directory__
* List the directories and browse for more sensitive files
> file download 		__//Using objection shell, you may download files__
> sqlite connect databasename.db 		__//connect to sqlite database__

### 2.  Check stored data on client side/local storage in Keychain (apple's recommended way of storing passwords, certificates, identities, notes and keys, Wi-Fi-passwords) #JB Only

* Use keychain dumper [https://github.com/ptoomey3/Keychain-Dumper]
* Extract and copy keychain_dumper file to your device (/tmp/anyfolder)
* Move to the directory where you have keychain_dumper and run it 
> ./keychain_dumper filename.txt 		__//Run KD and provide an output file where is complete keychain dumped in cleartext__
* If passwords or critical data is found in cleartext in keychain, report it.

### 3. Server-side vulnerabilities that are common to web application
* Use Burpsuite, NMAP and Nessus to find server side vulnerabilities

### 4. Check if application Logs anything sensitive
* In Xcode - Devices and simulators - Open Console 		__//Shows logs of the application__
* Launch and use the application, check the logs for data

### 5. Pasteboard/Clipboard sharing
* Launch objection shell
> ios pasteboard monitor 		__//Objection module to monitor clipboard__
* Use application and copy some text from it, if it shows in the monitor shell, application allows clipboard sharing.

### 6. Jailbreak Detection and Bypass

##### Method 1: JB Bypass using Objection
> applesign -L 		__//Lists all signing identities(long string of characters) available__
> ios hooking search classes <keyword like jailbreak> 		__//returns Jailbreak detection classes if present__
> ios hooking search methods <keyword like jailbreak> 		__//returns Jailbreak detection methods if present__
> ios hooking set return_value "+[method name]" false 		__//modify the return value of a method__
> objection patchipa --source targetapp.ipa --codesign-signature <your signing identity>  -P <path to provisioning profile> 		__//new patched file will be created__
> * Launch the app, if it breaks, extract classes and see Jailbreak detection method. If it does not, use objection's 'ios jailbreak disable' module
> * If it breaks, use the following objection command to run this command as soon as the application is launched
> objection --gadget "com.app.name" explore -s "ios jailbreak disable"

##### Method 2: JB Bypass using Frida
> frida -U -p PID -l <Find Class>.js 		__//Identify Class__
> frida -U -p PID -l <Find Method>.js 		__//find methods__
> frida -U -p PID -l <Modified return value>.js 		__//modify return values for a method__


### 7. Class information dumping (static analysis)
* Download class dump [http://stevenygard.com/projects/class-dump/]
* Extract it and move application IPA to the folder, extract IPA too as ZIP
* Show packages and copy binary to root of class dump folder
> ./class-dump appbinaryname 		__//this will extract classes of the application__
* Check for Jailbreak detection method

### 8. Bypass SSL Pinning
> frida-trace -U -m "*[NSURLRequest *] -n "appname"	__//Capture request and responses. Generate handler files for all methods at runtime (use - to see instance methods and + to see class methods, use * for both)__
* Create Frida scripts (use template provided by course)
* Use objection's module 'ios hooking watch method'


### 9. Check Deep links & URL schema

### 10. Dump memory heap of application
##### Method 1: Using Fridump
> frida-ps -Ua 		__//Find the application name__
> python fridump.py -U <applicationname> 		__//dump memory__
> python fridump.py -U  ShowSecret -s 		__//Run strings on the dumped memory files__

##### Method 2: Using Objection
> memory dump all appname.dmp 		__//In objection shell__
* View this dmp file and check strings of application for sensitive information using 'strings appname.dmp'
* Check for hardcoded strings with sensitive values